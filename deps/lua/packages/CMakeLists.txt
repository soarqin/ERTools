macro(list_subdir result curdir)
    file(GLOB children RELATIVE ${curdir} ${curdir}/*)
    set(dirlist "")
    foreach(child ${children})
        if(IS_DIRECTORY ${curdir}/${child})
            list(APPEND dirlist ${child})
        endif()
    endforeach()
    set(${result} ${dirlist})
endmacro()

list_subdir(SUBDIRS ${CMAKE_CURRENT_SOURCE_DIR})
set(LUA_EXTRA_PKGS)
foreach(subdir ${SUBDIRS})
    if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/${subdir}/CMakeLists.txt)
        message(STATUS "[Package] Adding ${subdir}")
        list(APPEND CMAKE_MESSAGE_INDENT "  ")
        add_subdirectory(${subdir})
        list(POP_BACK CMAKE_MESSAGE_INDENT)
        list(APPEND LUA_EXTRA_PKGS ${subdir})
    endif()
endforeach()
if(LUA_EXTRA_PKGS)
    ADD_LIBRARY(lua_extra_pkgs INTERFACE)
    TARGET_INCLUDE_DIRECTORIES(lua_extra_pkgs INTERFACE ${CMAKE_CURRENT_SOURCE_DIR})
    TARGET_LINK_LIBRARIES(lua_extra_pkgs INTERFACE ${LUA_EXTRA_PKGS})
endif()
